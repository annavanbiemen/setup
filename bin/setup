#!/bin/bash

# Exit on errors
set -euo pipefail

# Change directory to the setup home
cd "$(dirname "$(dirname "$(realpath "${BASH_SOURCE[0]}")")")"

# Source the env script
source ./env

# Import libraries
source ./lib/standard.sh
source ./lib/remote.sh
source ./lib/config.sh
source ./lib/recipe.sh
source ./lib/task.sh
source ./lib/apt.sh

# Add recipes
#
# Usage: setup::add <recipe>...
#
# Arguments
#   recipe  Recipe(s) to add
setup::add() {
    while [[ "$#" -gt 0 ]]; do
        task::schedule "recipe::$1"
        shift
    done

    # Run all scheduled tasks
    task::work
}

# List available recipes with comments
#
# Usage: setup::list
setup::list() {
    echo "Recipes:"
    task::list recipe
}

# Summarize available recipes
#
# Usage: setup::summary
setup::summary() {
    task::summary recipe
}

# Setup development environment by running recipes
#
# Usage: setup [command]
#
# Commands:
#   add recipe...  Add recipes
#   help           Show help information
#   list           List available recipes with comments
#   summary        Summarize available recipes
#   version        Show version information
#
# Arguments:
#   recipe  One or more recipes to execute
setup::main() {
    # Read command
    local command="${1:-help}"

    # Dispatch command
    case "${command}" in
    add)
        shift
        setup::add "$@"
        ;;
    list)
        setup::list
        ;;
    summary)
        setup::summary
        ;;
    help)
        standard::help setup::main
        ;;
    version)
        standard::version
        ;;
    *)
        standard::raise "Unknown command: ${command}"
        ;;
    esac
}

# Invoke main entrypoint
setup::main "$@"
