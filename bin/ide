#!/bin/bash

set -euo pipefail

default="code"
python="pycharm $default"
php="phpstorm $default"
rust="rustrover $default"

ide() {
	return
}

launch() {
	dir="$2"
	if [ "$dir" = "$PWD" ]; then
		dir="."
	fi

	ides="$1"
	for ide in $ides code; do
		if [ -n "$( which "$ide" )" ]; then
			echo "Launching $ide ${dir/"$HOME"/"~"}"
			nohup "$ide" "$dir" &>/dev/null &
			exit 0
		fi
	done

	echo "None of the following IDE's were found: $ides"
	exit 3
}

# Read the starting directory
dir=$( realpath "${1:-$PWD}" )
if [ ! -d "${dir}" ]; then
	echo "Not a directory: $1"
	exit 1
fi

# Scan directories untill we encounter $HOME or /
while [ "$dir" != "/" ]; do
	if [ "$dir" = "$HOME" ]; then
		break
	fi
	if [ -f "$dir/composer.json" ]; then
		launch "$php" "$dir"
	elif [ -f "$dir/pyproject.toml" ]; then
		launch "$python" "$dir"
	elif [ -f "$dir/Cargo.toml" ]; then
		launch "$rust" "$dir"
	elif [ -f "$dir/README.md" ] || [ -f "$dir/LICENSE" ]; then
		launch "$default" "$dir"
	fi
	dir=$( dirname "$dir" )
done

echo "Project directory not found."
exit 2
